<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scoula.products.mapper.PensionProductMapper">

    <!-- 상품 ID로 연금 상품 상세 정보 조회 -->
    <select id="findByProductId" resultType="org.scoula.products.dto.response.pension.PensionProductDTO">
        SELECT pp.*, fp.fin_co_no, fp.fin_prdt_cd, fp.product_name as fin_prdt_nm, fp.kor_co_nm
        FROM pension_product pp
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.fin_prdt_cd = #{productId}
    </select>

    <!-- 상품 ID로 연금 상품 옵션 정보 조회 -->
    <select id="findOptionsByProductId" resultType="org.scoula.products.dto.response.pension.PensionOptionDTO">
        SELECT po.*
        FROM pension_option po
                 JOIN financial_product fp ON po.product_id = fp.product_id
        WHERE fp.fin_prdt_cd = #{productId}
    </select>

    <!-- 연금 상품 목록 조회 (필터링 적용) -->
    <select id="findPensionProducts" resultType="org.scoula.products.dto.response.pension.PensionProductDTO">
        SELECT
        fp.fin_prdt_cd as "finPrdtCd",
        fp.kor_co_nm as "korCoNm",
        fp.product_name as "finPrdtNm",
        pp.pnsn_kind as "pnsnKind",
        pp.pnsn_kind_nm as "pnsnKindNm",
        CAST(pp.dcls_rate AS CHAR) as "dclsRate",
        CAST(pp.guar_rate AS CHAR) as "guarRate",
        fp.external_link as "joinWay"
        FROM financial_product fp
        JOIN pension_product pp ON fp.product_id = pp.product_id
        <where>
            <if test="pnsnKind != null and pnsnKind != ''">
                AND pp.pnsn_kind = #{pnsnKind}
            </if>
            <if test="prdtType != null and prdtType != ''">
                AND pp.prdt_type = #{prdtType}
            </if>
            <if test="guarRate != null">
                AND pp.guar_rate >= #{guarRate}
            </if>
        </where>
    </select>

    <!-- 카테고리별 연금 유형 목록 조회 -->
    <select id="getDistinctPensionTypes" resultType="java.util.Map">
        SELECT DISTINCT pp.pnsn_kind    as "code",
                        pp.pnsn_kind_nm as "name"
        FROM pension_product pp
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.category_id = #{categoryId}
    </select>

    <!-- 카테고리별 보장 수익률 목록 조회 -->
    <select id="getDistinctGuaranteeRates" resultType="java.lang.Double">
        SELECT DISTINCT pp.guar_rate
        FROM pension_product pp
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.category_id = #{categoryId}
          AND pp.guar_rate IS NOT NULL
        ORDER BY pp.guar_rate
    </select>

    <!-- 카테고리별 납입 기간 목록 조회 -->
    <select id="getDistinctPaymentPeriods" resultType="java.lang.Integer">
        SELECT DISTINCT po.paym_prd
        FROM pension_option po
                 JOIN pension_product pp ON po.product_id = pp.product_id
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.category_id = #{categoryId}
          AND po.paym_prd IS NOT NULL
        ORDER BY po.paym_prd
    </select>

    <!-- 카테고리별 최소 월 납입금 조회 -->
    <select id="getMinMonthlyPayment" resultType="java.lang.Integer">
        SELECT MIN(po.mon_paym_atm)
        FROM pension_option po
                 JOIN pension_product pp ON po.product_id = pp.product_id
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.category_id = #{categoryId}
    </select>

    <!-- 카테고리별 최대 월 납입금 조회 -->
    <select id="getMaxMonthlyPayment" resultType="java.lang.Integer">
        SELECT MAX(po.mon_paym_atm)
        FROM pension_option po
                 JOIN pension_product pp ON po.product_id = pp.product_id
                 JOIN financial_product fp ON pp.product_id = fp.product_id
        WHERE fp.category_id = #{categoryId}
    </select>
</mapper>